name: Smart Notifications

on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 7ì‹œ (KST 19:00 = UTC 10:00)
    - cron: '0 10 * * *'
    # ë§¤ì¼ ì˜¤í›„ 9ì‹œ (KST 21:00 = UTC 12:00)
    - cron: '0 12 * * *'
    # ë§¤ì¼ ì˜¤í›„ 11ì‹œ (KST 23:00 = UTC 14:00)
    - cron: '0 14 * * *'
    # ë§¤ì‹œê°„ ì²´í¬ (ì„ë°• ì•Œë¦¼ìš©)
    - cron: '0 * * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
          - check
          - trigger
      force_send:
        description: 'Force send notifications even if not regular time'
        required: false
        default: false
        type: boolean

jobs:
  smart-notifications:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Check smart notifications
        env:
          # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

          # VAPID í‚¤ (í‘¸ì‹œ ì•Œë¦¼ìš©)
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}

          # Sentry ì„¤ì •
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}

          # NextAuth ì„¤ì •
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}

          # ë°°í¬ URL
          DEPLOYMENT_URL: ${{ secrets.DEPLOYMENT_URL }}

        run: |
          # í˜„ì¬ ì‹œê°„ í™•ì¸
          echo "ğŸ• Current time (UTC): $(date -u)"
          echo "ğŸ‡°ğŸ‡· Current time (KST): $(TZ=Asia/Seoul date)"

          # ì•¡ì…˜ ê²°ì •
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ACTION="${{ github.event.inputs.action }}"
            FORCE_SEND="${{ github.event.inputs.force_send }}"
          else
            ACTION="check"
            FORCE_SEND="false"
          fi

          echo "ğŸ“‹ Action: $ACTION"
          echo "âš¡ Force send: $FORCE_SEND"

          # API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
          if [ -n "$DEPLOYMENT_URL" ]; then
            API_URL="$DEPLOYMENT_URL/api/notifications/smart-check"
          else
            API_URL="https://last-move.vercel.app/api/notifications/smart-check"
          fi

          echo "ğŸŒ API URL: $API_URL"

          # ì•Œë¦¼ ì²´í¬ ë° ë°œì†¡
          RESPONSE=$(curl -s -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -d "{\"action\":\"$ACTION\",\"forceSend\":$FORCE_SEND}" \
            -w "HTTP_STATUS:%{http_code}")

          # HTTP ìƒíƒœ ì½”ë“œ ì¶”ì¶œ
          HTTP_STATUS=$(echo "$RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')

          echo "ğŸ“Š HTTP Status: $HTTP_STATUS"
          echo "ğŸ“„ Response Body: $BODY"

          # ê²°ê³¼ ì²˜ë¦¬
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Smart notifications check completed successfully"
            
            # ê²°ê³¼ íŒŒì‹± ë° ì¶œë ¥
            if command -v jq &> /dev/null; then
              echo "ğŸ“ˆ Analysis Result:"
              echo "$BODY" | jq '.'
            else
              echo "ğŸ“ˆ Raw Response: $BODY"
            fi
          else
            echo "âŒ Smart notifications check failed with status $HTTP_STATUS"
            echo "âŒ Response: $BODY"
            exit 1
          fi

      - name: Send status to Sentry
        if: always()
        run: |
          # Sentryì— ì‹¤í–‰ ìƒíƒœ ë³´ê³  (ì„ íƒì )
          if [ -n "$SENTRY_DSN" ]; then
            echo "ğŸ“¤ Sending status to Sentry..."
            
            # ì—¬ê¸°ì„œ Sentry SDKë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰ ìƒíƒœë¥¼ ë³´ê³ í•  ìˆ˜ ìˆìŒ
            # í˜„ì¬ëŠ” ë‹¨ìˆœíˆ ë¡œê·¸ë§Œ ì¶œë ¥
            echo "Sentry DSN configured, status reporting available"
          fi

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleanup completed"
          echo "â° Workflow finished at: $(date -u)"
